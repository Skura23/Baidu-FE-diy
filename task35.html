<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style type="text/css">
	*{
		margin: 0;
		padding: 0;
	}
	button{
		margin-left: 25px;
	}
	.wrapper{
		overflow: hidden;
	}
	.x-axis{
		margin-left: 30px;
		overflow: hidden;
	}
	.y-axis{
		width: 30px;
		float: left;
	}
	.x-num{
		display: block;
		float: left;
		width: 40px;
		height: 30px;
		line-height: 30px;
		text-align: center;
	}
	.y-num{
		display: block;
		width: 30px;
		height: 40px;
		text-align: center;
		line-height: 40px;
	}
	.map-zone{
		width: 400px;
		height: 400px;
		border: 2px solid black;
		float: left;
		position: relative;
	}
	.map-cell{
		display: block;
		float: left;
		width: 39px;
		height: 39px;
		border: 1px solid gray;
		border-left: none;
		border-top: none;
	}
	.controller{
		margin: 20px 0 0 30px;
	}
	.box{
		width: 39px;
		height: 31px;
		background: red;
		border-top: 8px solid blue;
		position: absolute;
		left: 80px;
		top: 80px;
		/* transform: rotate(90deg); */
	}
	.cmd-panel{
		margin-top: 20px;
	}
	.panel-nums{
		display: block;
		width: 20px;
		min-height: 101px;
		background: gray;
		position: absolute;
	}
	.cmd-panel textarea{
		height: 100px;
		background: black;
		color: #fff;
		line-height: 20px;
		margin-left: 3px;
	}
	.panel-nums span
	{	
		display: block;
		width: 20px;
		height: 20px;
		color: black;
		text-align: center;
		border-radius: 10px;
	}
	/* num外添加div，滚动时得到数字隐藏效果 */
	.num-wra{
		width: 20px;
		height: 101px;
		overflow: hidden;
		float: left;
		position: relative;
	}
	.wrongs{
		background: red; 
	}
	.instructions{
		border: 1px solid black;
		position: absolute;
		width: 500px;
		right: 50px;
		top: 80px;
		padding: 10px
	}
	.block{
		position: absolute;
		background: gray;
		width: 39px;
		height: 39px;
	}
	</style>
</head>
<body>
<div class="wrapper">
	<div class="x-axis">
		<span class="x-num">1</span><span class="x-num">2</span><span class="x-num">3</span>
		<span class="x-num">4</span><span class="x-num">5</span><span class="x-num">6</span>
		<span class="x-num">7</span><span class="x-num">8</span><span class="x-num">9</span>
		<span class="x-num">10</span>
	</div>
	<div style="overflow: hidden;">
		<div class="y-axis">
			<span class="y-num">1</span><span class="y-num">2</span><span class="y-num">3</span>
			<span class="y-num">4</span><span class="y-num">5</span><span class="y-num">6</span>
			<span class="y-num">7</span><span class="y-num">8</span><span class="y-num">9</span>
			<span class="y-num">10</span>
		</div>
		<div class="map-zone">
			<span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span>
			<span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span>
			<span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span>
			<span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span>
			<span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span>
			<span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span>
			<span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span>
			<span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span>
			<span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span>
			<span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span><span class="map-cell"></span>
			<div class="box">
				
			</div>
		</div>
	</div>
	<div class="controller">
		<button>执行</button><button>清空</button>
		
		<div class="cmd-panel">
			<div class="num-wra">
				<div class="panel-nums"></div>
			</div>
			<textarea></textarea>
		</div>
	</div>
	<div class="instructions">
		在输入框中允许输入如下指令，按下按钮后，使得正方形做相应动作
		移动不能超出格子空间<br>
		GO：向蓝色边所面向的方向前进一格（一格等同于正方形的边长<br>
		TUN LEF：向左转（逆时针旋转90度）<br>
		TUN RIG：向右转（顺时针旋转90度）<br>
		TUN BAC：向右转（旋转180度）<br>
		TRA LEF：向屏幕的左侧移动一格，方向不变<br>
		TRA TOP：向屏幕的上面移动一格，方向不变<br>
		TRA RIG：向屏幕的右侧移动一格，方向不变<br>
		TRA BOT：向屏幕的下面移动一格，方向不变<br>
		MOV LEF：方向转向屏幕左侧，并向屏幕的左侧移动一格<br>
		MOV TOP：方向转向屏幕上面，向屏幕的上面移动一格<br>
		MOV RIG：方向转向屏幕右侧，向屏幕的右侧移动一格<br>
		MOV BOT：方向转向屏幕下面，向屏幕的下面移动一格<br>
		GO 3：向当前方向前进三格<br>
		TRA TOP 2：向屏幕上方平移两格<br>
		MOV RIG 4：方向转向屏幕右侧，向屏幕的右侧移动四格<br>
	</div>
</div>
<script type="text/javascript">
function Box (box){
	this.box = box,
	this.boxDeg = 0
};
Box.prototype = {
	constructor: Box,
	//tun, go的运行由其函数内部进行判断
	//以tun, go作为单位动作,参数有times, dir, 分别代表次数和方向
	tunFunc: function(cmdDir){
		var argus = {};
		if(cmdDir == 'LEF'){
			argus.dis  = -1;
		}else if(cmdDir == 'RIG'){
			argus.dis  = 1;
		}else if(cmdDir == 'BAC'){
			argus.dis  = 2;
		}
		this.degMove(argus);
	},
	goFunc: function(cmdTimes){
		var boxDeg = 0;
		boxDeg = this.boxDeg % 360;
		var argus = {};
		if(boxDeg == 0){
			argus.type = 'top';
			argus.dir = -1;
		}else if(boxDeg == 90){
			argus.type = 'left';
			argus.dir = 1;
		}else if(boxDeg == 180){
			argus.type = 'top';
			argus.dir = 1;
		}else if(boxDeg == 270){
			argus.type = 'left';
			argus.dir = -1;
		}
		argus.times = cmdTimes ? cmdTimes : 1;
		this.posMove(argus);
	},
	traFunc: function(cmdDir, cmdTimes){
		var argus = {};
		if (cmdDir == 'LEF') {
			argus.type = 'left';
			argus.dir = -1;
		}else if(cmdDir == 'RIG'){
			argus.type = 'left';
			argus.dir = 1;
		}else if(cmdDir == 'TOP'){
			argus.type = 'top';
			argus.dir = -1;
		}else if(cmdDir == 'BOT'){
			argus.type = 'top';
			argus.dir = 1;
		}
		argus.times = cmdTimes ? cmdTimes : 1;
		this.posMove(argus)
	},
	movFunc: function(cmdDir, cmdTimes){
		var argus = {};
		if (cmdDir == 'LEF') {
			argus.dest = 270;
		}else if(cmdDir == 'RIG'){
			argus.dest = 90;
		}else if(cmdDir == 'TOP'){
			argus.dest = 0;
		}else if(cmdDir == 'BOT'){
			argus.dest = 180;
		}
		var startDeg = this.boxDeg;
		//使box转角大于180时，择小角度旋转
		if(Math.abs(argus.dest - startDeg) > 180){
			if(argus.dest > startDeg){
				argus.dis = (argus.dest - startDeg -360) / 90;
			}else if(argus.dest < startDeg){
				argus.dis = (360 - (startDeg - argus.dest)) / 90;
			}
		}else{
			argus.dis = (argus.dest - startDeg) / 90;
		}
		this.degMove(argus);
		argus.go = true;
		argus.times = cmdTimes ? cmdTimes : 1;
	},
	degMove: function(argus){
		var oThis = this;
		var startDeg = this.boxDeg;
		var curDeg = startDeg;
		function animateDeg(){
			curDeg += argus.dis * 90 / 30;
			oThis.box.style.transform = 'rotate('+ curDeg +'deg)';
			if(curDeg == startDeg + 90 * argus.dis){
				clearInterval(t);
				//保证每次角度旋转后 角度都是0-360的正数
				oThis.boxDeg = curDeg % 360;
				oThis.boxDeg <= 0 && (oThis.boxDeg = oThis.boxDeg + 360);
				//如果参数go为true则执行go否则执行下个cmd
				argus.go ? oThis.goFunc(argus.times) : oThis.cmdHandler();
			}
		}
		var t = setInterval(animateDeg, 10)
	},
	posMove: function (argus){
		var oThis = this;
		//需要兼容性处理
		//获取当前位置
		var startPos = parseInt(getComputedStyle(this.box, null)[argus.type]);
		var curPos = startPos;
		oThis.borderCheck(curPos, argus.dir, argus.times);
		argus.times = this.times;
		function animatePos(){
			
			curPos += (40 * argus.times * argus.dir)/40;
			oThis.box.style[argus.type] = curPos + 'px';
			if (curPos == startPos + 40 * argus.dir * argus.times) {
				clearInterval(p);
				oThis.cmdHandler();
			}
			
		}
		var p = setInterval(animatePos, 10)
	},
	//外部命令转换系统，将外部命令转换为对象内部语言
	cmdHandler: function(){

		if(this.index == this.rightCmds.length) return;
		var command = this.rightCmds[this.index];
		var abbrCmd = command.slice(0, 3);
		var cmdDir = command.slice(4, 7);
		var cmdTimes = command.slice(8, 9);
		command.indexOf('GO') != -1 && (abbrCmd = command.slice(0, 2), cmdTimes = command.slice(3, 4));
		abbrObjCmd = abbrCmd.toLowerCase() + 'Func';
		console.log(abbrObjCmd);
		abbrObjCmd == 'goFunc' ? this[abbrObjCmd](cmdTimes) : this[abbrObjCmd](cmdDir, cmdTimes);
		this.index ++;
	},
	//碰撞检测
	borderCheck: function(curPos, dir, times){
		var maxTimes = 0;
		maxTimes = dir > 0 ? (360- curPos)/40 : curPos/40;
		if(times > maxTimes){
			this.times = maxTimes
		}else{
			this.times = times
		}
	},
	//obj的建墙功能
	buildFunc: function(){
		var boxDeg = this.boxDeg;
		var argus = {};
		var blockPos = [];
		//可用范围
		var xRange = [0, 360];
		var yRange = [0, 360];
		if(boxDeg == 0){
			argus.type = 'top';
			argus.dir = -1;
		}else if(boxDeg == 90){
			argus.type = 'left';
			argus.dir = 1;
		}else if(boxDeg == 180){
			argus.type = 'top';
			argus.dir = 1;
		}else if(boxDeg == 270){
			argus.type = 'left';
			argus.dir = -1;
		}
		var curPosX = parseInt(getComputedStyle(this.box, null)['left']);
		var curPosY = parseInt(getComputedStyle(this.box, null)['top']);
		if(argus.type == 'left'){
			blockPos[1] = curPosY;
			blockPos[0] = curPosX + argus.dir * 40;
		}else if(argus.type == 'top'){
			blockPos[1] = curPosY + argus.dir * 40;
			blockPos[0] = curPosX;
		}
		//碰撞处理
		if(blockPos[0] < xRange[0] || blockPos[0] < yRange[0] || blockPos[1] > xRange[1] || blockPos[1] > yRange[1]){
			console.log('此处不能建墙');
			return
		}
		var oDiv = document.createElement('div');
		oDiv.className = 'block';
		oDiv.style.left = blockPos[0] + 'px';
		oDiv.style.top = blockPos[1] + 'px';
		this.box.parentNode.appendChild(oDiv);
	}
}
window.onload = function(){
	var oBox = document.getElementsByClassName('box')[0];
	var oContr = document.getElementsByClassName('controller')[0];
	var oBtn = oContr.getElementsByTagName('button')[0];
	var clearBtn = oContr.getElementsByTagName('button')[1];
	var buildBtn = oContr.getElementsByTagName('button')[2];
	var panel = document.getElementsByClassName('cmd-panel')[0];
	var panelNums = panel.getElementsByClassName('panel-nums')[0];
	var panelTxt = panel.getElementsByTagName('textarea')[0];
	var cmdsArr = ['GO', 'TUN LEF', 'TUN RIG', 'TUN BAC', 'TRA LEF', 'TRA TOP', 'TRA RIG', 'TRA BOT', 'MOV LEF', 'MOV TOP', 'MOV RIG', 'MOV BOT'];

	var obj = new Box(oBox);
	//获取textarea的命令集合
	//通过callback回调函数方法，将对象状态返回给控制台，根据状态触发命令
	oBtn.onclick = function(){
		obj.cmds = panelTxt.value.split('\n');
		//将内容数据变为大写
		for(var i = 0; i < obj.cmds.length; i++){
			obj.cmds[i] = obj.cmds[i] ? obj.cmds[i].toUpperCase() : obj.cmds[i];
		}
		//检查命令是否错误
		checkCmds();
		console.log(obj.cmds)
		console.log(obj.rightCmds)
		obj.index = 0;
		obj.cmdHandler();
		renderWrongs()
	};
	panelTxt.onkeyup = function(){
		this.rowData = [];
		var numLen = this.value.split('\n').length;
		//获取数组
		for( var i = 1; i < numLen + 1; i++){
			this.rowData.push(i)
		}
		//渲染
		renderNums(this.rowData)
	}
	//渲染左侧行数标识
	function renderNums (rowData){
		panelNums.innerHTML = ''
		for( var i = 0; i < rowData.length; i++){
			var oSpan = document.createElement('span');
			oSpan.textContent = rowData[i];
			panelNums.appendChild(oSpan)
		}
	}
	//确保num指示可随textarea滚动条滚动
	panelTxt.onscroll = function(){
		panelNums.style.top = - this.scrollTop + 'px'
		console.log(this.scrollTop)
	}
	//清空按钮
	clearBtn.onclick = function(){
		panelTxt.value = '';
		var rowData = [];
		renderNums(rowData)
	}
	function checkCmds (){
		var rightCmds = [];
		var wrongCmds = [];
		//每个数据加上索引标记，供后面wrongCmds的渲染
		var indexs = [];
		for(var i = 0; i < obj.cmds.length; i++){
			//如果最后位是数字
			if(!isNaN(obj.cmds[i].slice(-1))){
				var sCmd = obj.cmds[i].slice(0, -2);
				
				if(!['TUN LEF', 'TUN RIG', 'TUN BAC'].includes(sCmd)) {
					cmdsArr.includes(sCmd) ? rightCmds.push(obj.cmds[i]) : (wrongCmds.push(obj.cmds[i]), indexs.push(i));
				} else{
					wrongCmds.push(obj.cmds[i]);
					indexs.push(i)
				}
			}else{
				//如果最后位不是数字
				cmdsArr.includes(obj.cmds[i]) ? rightCmds.push(obj.cmds[i]) : (wrongCmds.push(obj.cmds[i]), indexs.push(i));
			}
		}
		obj.rightCmds = rightCmds;
		obj.wrongCmds = wrongCmds;
		obj.indexs = indexs;
		console.log(indexs)
	}
	function renderWrongs (){
		var aSpan = panelNums.getElementsByTagName('span');
		//初始化class
		for(var i = 0; i < aSpan.length; i++){
			aSpan[i].classList.remove('wrongs');
		}
		//对应index的span添加错误提示
		for(var i = 0; i < aSpan.length; i++){
			obj.indexs.includes(i) && aSpan[i].classList.add('wrongs');
		}
	}
	buildBtn.onclick = function(){
		obj.buildFunc()
	}
}
</script>
</body>
</html>